<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æç®€ç™»å½•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 350px;
            margin: 50px auto;
            padding: 20px;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        #loginBtn { width: 100%; padding: 10px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #loginBtn:hover { background: #0056b3; }
        .success { color: green; margin-top: 10px; text-align: center; }
        .error { color: red; margin-top: 10px; text-align: center; }
        .url-tip { margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 14px; }
        .url-link { color: #007bff; text-decoration: underline; cursor: pointer; }
    </style>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.27.2/axios.min.js"></script>
</head>
<body>
<h2 style="text-align: center;">ç³»ç»Ÿç™»å½•</h2>

<div class="form-group">
    <label for="username">ç”¨æˆ·å</label>
    <input type="text" id="username" placeholder="è¾“å…¥ç”¨æˆ·å" required>
</div>

<div class="form-group">
    <label for="password">å¯†ç </label>
    <input type="password" id="password" placeholder="è¾“å…¥å¯†ç " required>
</div>

<button id="loginBtn">ç™»å½•</button>

<div id="successMsg" class="success"></div>
<div id="errorMsg" class="error"></div>

<!-- ç™»å½•æˆåŠŸåæ˜¾ç¤ºå¸¦ Token çš„ URL -->
<div id="urlContainer" class="url-tip" style="display: none;">
    æ‰‹åŠ¨è®¿é—®é“¾æ¥ï¼ˆå·²å« Tokenï¼‰ï¼š<br>
    <span id="helloUrl" class="url-link"></span><br>
    <small>å¤åˆ¶ä¸Šé¢é“¾æ¥åˆ°åœ°å€æ ï¼Œæˆ–ç‚¹å‡»ç›´æ¥è®¿é—®</small>
</div>

<script>
    $(document).ready(function() {
        // æ‹¦æˆªå™¨ï¼šAxios è¯·æ±‚è‡ªåŠ¨æºå¸¦ Tokenï¼ˆæŒ‰é’®è®¿é—®ç”¨ï¼‰
        axios.interceptors.request.use(
            function(config) {
                if (config.url !== '/login') {
                    const token = localStorage.getItem('token');
                    if (token) {
                        config.headers.Authorization = 'Bearer ' + token;
                    }
                }
                return config;
            },
            function(error) {
                return Promise.reject(error);
            }
        );

        $('#loginBtn').click(function() {
            const username = $('#username').val().trim();
            const password = $('#password').val().trim();

            if (!username) {
                $('#errorMsg').text('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            if (!password) {
                $('#errorMsg').text('è¯·è¾“å…¥å¯†ç ');
                return;
            }

            axios.post('/login', { username: username, password: password })
                .then(function(res) {
                    const data = res.data;
                    console.log("åç«¯è¿”å›ï¼š", data);

                    if (data.success || data.code === 200 || data.code === 0) {
                        const token = data.token || (data.data && data.data.token);
                        if (token) {
                            localStorage.setItem('token', token);
                            $('#successMsg').text('ç™»å½•æˆåŠŸï¼');
                            $('#errorMsg').text('');

                            // ğŸ”¥ æ‹¼æ¥å¸¦ Token çš„ URLï¼ˆ?token=xxxï¼‰
                            const helloUrl = window.location.origin + '/hello?token=' + token;
                            $('#helloUrl').text(helloUrl);
                            $('#urlContainer').show(); // æ˜¾ç¤ºå¸¦ Token çš„é“¾æ¥

                            // ç‚¹å‡»é“¾æ¥ç›´æ¥è®¿é—®
                            $('#helloUrl').click(function() {
                                window.open(helloUrl, '_self');
                            });
                        } else {
                            $('#errorMsg').text('ç™»å½•å¤±è´¥ï¼šæœªè·å–åˆ° Token');
                        }
                    } else {
                        $('#errorMsg').text(data.msg || 'ç™»å½•å¤±è´¥');
                    }
                })
                .catch(function(error) {
                    console.error("ç™»å½•è¯·æ±‚é”™è¯¯ï¼š", error);
                    if (error.response && error.response.status === 403) {
                        $('#errorMsg').text('ç™»å½•è¢«æ‹’ç»ï¼ˆ403ï¼‰ï¼Œè¯·æ£€æŸ¥åç«¯ CSRF é…ç½®');
                    } else {
                        $('#errorMsg').text('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });
        });
    });
</script>
</body>
</html>